
<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अनिक फायनान्सीयल सर्वीसेस - दैनंदिन अपडेट</title>
    <style>
        /* ... तुमचा CSS पूर्वीप्रमाणेच ... */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap');
        :root { 
            --primary-color: #0056b3; --secondary-color: #007bff; --accent-color: #28a745;
            --info-color: #17a2b8; --danger-color: #dc3545; --light-gray: #f8f9fa;
            --medium-gray: #e9ecef; --dark-gray: #343a40; --text-color: #212529;
            --border-radius: 8px; --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans Devanagari', sans-serif; background-color: var(--light-gray);
            color: var(--text-color); line-height: 1.6; padding: 20px; display: flex;
            flex-direction: column; align-items: center;
        }
        .container { 
            background-color: #fff; padding: 30px; border-radius: var(--border-radius);
            box-shadow: var(--box-shadow); width: 100%; max-width: 900px; margin-bottom: 20px;
        }
        header { 
            text-align: center; margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        header h1 { color: var(--primary-color); font-size: 1.8em; margin-bottom: 5px; }
        header h2 { color: var(--secondary-color); font-size: 1.4em; font-weight: 500; }
        .form-section-title { 
            font-size: 1.3em; color: var(--primary-color); margin-top: 30px;
            margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--medium-gray);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--dark-gray); }
        .form-group input[type="text"], .form-group input[type="tel"],
        .form-group input[type="number"], .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius); font-size: 1em; font-family: 'Noto Sans Devanagari', sans-serif;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .form-group input[type="number"] { -moz-appearance: textfield; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 86, 179, 0.25); outline: none;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .button-group {
            margin-top: 30px; display: flex; flex-wrap: wrap;
            gap: 15px; justify-content: flex-start;
        }
        .btn {
            padding: 12px 25px; font-size: 1em; font-weight: 500;
            border-radius: var(--border-radius); border: none; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'Noto Sans Devanagari', sans-serif; text-align: center;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-add-to-list { background-color: var(--accent-color); color: #fff; }
        .btn-add-to-list:hover { background-color: #218838; }
        .btn-print { background-color: var(--info-color); color: #fff; } 
        .btn-print:hover { background-color: #138496; }
        .btn-save-to-sheet { background-color: #ff8c00; color: #fff; } 
        .btn-save-to-sheet:hover { background-color: #cc7000; }

        #addedBorrowersSection { 
            margin-top: 30px; border-top: 1px solid var(--medium-gray); padding-top: 20px;
        }
        #addedBorrowersSection h3 { color: var(--primary-color); margin-bottom: 15px; }
        #borrowersDisplayList { 
            list-style: none; padding: 0;
        }
        #borrowersDisplayList li { 
            background-color: var(--light-gray); padding: 10px 15px; border-radius: var(--border-radius);
            margin-bottom: 10px; border-left: 5px solid var(--info-color); display: flex;
            justify-content: space-between; align-items: center; flex-wrap: wrap;
        }
        #borrowersDisplayList li .borrower-info { font-size: 0.95em; flex-grow: 1; margin-right: 10px; }
        #borrowersDisplayList li .remove-btn { 
            background-color: var(--danger-color); color: white; border: none;
            padding: 5px 10px; border-radius: 4px; cursor: pointer;
            font-size: 0.8em; flex-shrink: 0;
        }
        #borrowersDisplayList li .remove-btn:hover { background-color: #c82333; }
        #printOnlyArea { display: none; } 
        #sheetSaveStatus {text-align:center; margin-top:15px; font-weight:500; padding: 8px; border-radius: var(--border-radius);}
        #sheetSaveStatus.success { color: green; background-color: #e6ffed; border: 1px solid #5cb85c;}
        #sheetSaveStatus.error { color: red; background-color: #fdeded; border: 1px solid #d9534f;}
        #sheetSaveStatus.info { color: orange; background-color: #fff3e0; border: 1px solid #ffc107;}


        @media print { 
            body { 
                margin: 0; padding: 0; background-color: #fff !important; 
                 -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important;
            }
            body > *:not(#printOnlyArea) { display: none !important; }
            #printOnlyArea { 
                display: block !important; position: static !important; margin: 0 auto; 
                padding: 15mm 10mm; font-size: 10pt; color: #000 !important; 
                background-color: #fff !important; width: 100%; box-sizing: border-box;
            }
            .print-header-block { 
                text-align: center; margin-bottom: 15px; border-bottom: 1.5pt solid #000; padding-bottom: 8px;
            }
            .print-header-block h1 { font-size: 15pt !important; color: #000 !important; margin-bottom: 3px; font-weight: bold; }
            .print-header-block h2 { font-size: 11pt !important; color: #000 !important; font-weight: normal; }
            .print-meta-info-block { display: flex; justify-content: space-between; font-size: 8.5pt; margin-bottom: 12px; }
            .print-entries-container { column-count: 2; column-gap: 8mm; column-fill: auto;  }
            .print-borrower-item { 
                border: 0.5pt solid #ccc; padding: 5pt; margin-bottom: 6pt; 
                page-break-inside: avoid !important; -webkit-column-break-inside: avoid; 
                break-inside: avoid-column; font-size: 8.5pt; line-height: 1.25; 
            }
            .print-borrower-item p { margin-bottom: 2.5pt; }
            .print-borrower-item strong { font-weight: bold; }
            @page { size: A4 portrait;  margin: 0mm;  }
        }
        
        @media (max-width: 600px) { 
            header h1 { font-size: 1.5em; } header h2 { font-size: 1.2em; }
            .container { padding: 20px; } .btn { width: 100%; }
            #borrowersDisplayList li .borrower-info { margin-bottom: 5px; }
            @media print { .print-entries-container { column-count: 1; } }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <header>
            <h1>अनिक फायनान्सीयल सर्वीसेस प्रा.लि.</h1>
            <h2>केज युनिट - एफ एक्स दैनंदिन अपडेट</h2>
        </header>

        <form id="financialForm">
            <div class="form-group">
                <label for="employeeName">आपले नांव निवडा:</label>
                <select id="employeeName" name="employeeName" required>
                    <option value="" disabled selected>--- नांव निवडा ---</option>
                    <option value="सविता चाळक">सविता चाळक</option>
                    <option value="आशा कापसे">आशा कापसे</option>
                    <option value="अशोक बिक्कड">अशोक बिक्कड</option>
                    <option value="विरभद्र पोटभरे">विरभद्र पोटभरे</option>
                </select>
            </div>
            <h3 class="form-section-title">कर्जदाराची माहिती नोंदवा</h3>
            <div class="form-group">
                <label for="borrowerName">कर्जदाराचे नांव:</label>
                <input type="text" id="borrowerName" name="borrowerName" required>
            </div>
            <div class="form-group">
                <label for="villageName">गावाचे नांव:</label>
                <input type="text" id="villageName" name="villageName" required>
            </div>
            <div class="form-group">
                <label for="mobileNumber">मोबाईल नंबर:</label>
                <input type="tel" id="mobileNumber" name="mobileNumber" pattern="[0-9]{10}" placeholder="उदा. 9876543210" required>
            </div>
            <div class="form-group">
                <label for="accountNumber">खाते क्रमांक:</label>
                <input type="text" id="accountNumber" name="accountNumber" required>
            </div>
            <div class="form-group">
                <label for="amountReceived">वसूल रक्कम (आल्यास):</label>
                <input type="number" id="amountReceived" name="amountReceived" placeholder="उदा. 5000" min="0">
            </div>
            <div class="form-group">
                <label for="discussionDetails">आपले त्यांचेशी काय बोलणे झाले ते नोंदवा:</label>
                <textarea id="discussionDetails" name="discussionDetails" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="recoveryPlan">सदरील खाते थकीत मधुन बाहेर काढण्यासाठी काय करणे गरजेचे आहे:</label>
                <textarea id="recoveryPlan" name="recoveryPlan" rows="3" required></textarea>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-add-to-list" onclick="addCurrentFormEntryToList()">हा फॉर्ममधील डेटा यादीत जोडा</button>
                <button type="button" class="btn btn-print" onclick="prepareContentAndPrint()">यादी प्रिंट/सेव्ह PDF करा</button> 
                <button type="button" class="btn btn-save-to-sheet" id="saveAllToListButton">यादीतील सर्व डेटा Sheet ला सेव्ह करा</button>
            </div>
        </form>

        <section id="addedBorrowersSection">
            <h3>ऑन-स्क्रीन जमा केलेला डेटा (Sheet वर सेव्ह करण्यासाठी आणि प्रिंटसाठी)</h3> <!-- शीर्षक बदलले -->
            <ul id="borrowersDisplayList"></ul>
        </section>
        <p style="text-align: center; margin-top: 20px; font-size: 0.9em;">टीप: 'प्रिंट/सेव्ह PDF' बटण दाबल्यावर, प्रिंट डायलॉगमध्ये 'Save as PDF' पर्याय निवडून PDF फाईल सेव्ह करू शकता.</p>
        <div id="sheetSaveStatus"></div>
    </div>

    <div id="printOnlyArea"></div>

    <script>
        window.onload = function() {
            console.log("Window loaded. Script initializing...");
            let allBorrowersDataForSheetAndPrint = []; // आता हा अॅरे प्रिंट आणि शीट दोन्हीसाठी वापरला जाईल
            
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwulZ7BG6mWmJcDymtg2sqVolhUfppigz3IMA_m9x0rGqIuTJhyzVu8MsBLxUdMPftw/exec"; 

            window.addCurrentFormEntryToList = function() {
                if (!validateFormForSheetSubmission()) { return; } 
                const amountReceivedValue = document.getElementById("amountReceived").value.trim();
                const currentEmployeeName = document.getElementById("employeeName").value;

                const borrowerData = {
                    employeeNameFromForm: currentEmployeeName,
                    borrowerName: document.getElementById("borrowerName").value.trim(),
                    villageName: document.getElementById("villageName").value.trim(),
                    mobileNumber: document.getElementById("mobileNumber").value.trim(),
                    accountNumber: document.getElementById("accountNumber").value.trim(),
                    amountReceived: amountReceivedValue ? parseFloat(amountReceivedValue) : null,
                    discussionDetails: document.getElementById("discussionDetails").value.trim(),
                    recoveryPlan: document.getElementById("recoveryPlan").value.trim(),
                    id: Date.now() 
                };
                allBorrowersDataForSheetAndPrint.push(borrowerData); // बदललेला अॅरे वापरा
                updateDisplayList(); 
                clearBorrowerFormFields(); 
                document.getElementById("borrowerName").focus(); 
                document.getElementById('sheetSaveStatus').textContent = `${allBorrowersDataForSheetAndPrint.length} नोंदी शीटवर पाठवण्यासाठी आणि प्रिंटसाठी तयार.`;
                document.getElementById('sheetSaveStatus').className = 'info';
            }

            function validateFormForSheetSubmission() {
                const employeeNameField = document.getElementById("employeeName");
                if (!employeeNameField.value) {
                    alert(`'आपले नांव निवडा' अनिवार्य आहे.`);
                    employeeNameField.focus(); return false;
                }
                const requiredFields = ["borrowerName", "villageName", "mobileNumber", "accountNumber", "discussionDetails", "recoveryPlan"];
                for (let fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        const labelElement = document.querySelector(`label[for='${fieldId}']`);
                        const labelText = labelElement ? labelElement.innerText.replace(':','') : fieldId;
                        alert(`कर्जदारासाठी '${labelText}' भरा.`);
                        field.focus(); return false;
                    }
                }
                const mobileField = document.getElementById("mobileNumber");
                if (!/^[0-9]{10}$/.test(mobileField.value)) {
                    alert("कृपया वैध १०-अंकी मोबाईल नंबर टाका.");
                    mobileField.focus(); return false;
                }
                return true;
            }
            
            // Display list function (uses the combined array)
            function updateDisplayList() {
                const listElement = document.getElementById("borrowersDisplayList");
                listElement.innerHTML = ""; 
                if (allBorrowersDataForSheetAndPrint.length === 0) {
                    listElement.innerHTML = "<p>अद्याप कोणताही डेटा यादीत जोडलेला नाही.</p>"; return;
                }
                allBorrowersDataForSheetAndPrint.forEach((borrower, index) => {
                    const listItem = document.createElement("li");
                    let amountText = "";
                    if (borrower.amountReceived !== null && borrower.amountReceived !== undefined && borrower.amountReceived > 0) {
                        amountText = ` (वसूल: ₹${parseFloat(borrower.amountReceived).toLocaleString('en-IN')})`;
                    }
                    listItem.innerHTML = `<span class="borrower-info">${index + 1}. ${borrower.borrowerName} (कर्मचारी: ${borrower.employeeNameFromForm}, खाते क्र.: ${borrower.accountNumber})${amountText}</span><button class="remove-btn" onclick="removeEntryFromList(${borrower.id})">यादीतून काढा</button>`;
                    listElement.appendChild(listItem);
                });
            }

            // Removes entry from the combined list
            window.removeEntryFromList = function(entryId) {
                allBorrowersDataForSheetAndPrint = allBorrowersDataForSheetAndPrint.filter(b => b.id !== entryId);
                updateDisplayList();
                let statusText = `${allBorrowersDataForSheetAndPrint.length} नोंदी शीटवर पाठवण्यासाठी आणि प्रिंटसाठी तयार.`;
                if(allBorrowersDataForSheetAndPrint.length === 0) {
                    statusText = "यादी आता रिकामी आहे.";
                }
                document.getElementById('sheetSaveStatus').textContent = statusText;
                document.getElementById('sheetSaveStatus').className = 'info';
            }

            function clearBorrowerFormFields() { 
                const fieldsToClear = ["borrowerName", "villageName", "mobileNumber", "accountNumber", "amountReceived", "discussionDetails", "recoveryPlan"];
                fieldsToClear.forEach(id => document.getElementById(id).value = "");
                document.getElementById("borrowerName").focus();
            }
                       
            function getCurrentDateMarathi() { 
                const date = new Date();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Print function (uses the combined array)
            window.prepareContentAndPrint = function() {
                const employeeNameForPrint = document.getElementById("employeeName").value;
                if (allBorrowersDataForSheetAndPrint.length === 0) { // Use combined array
                    alert("प्रिंट/सेव्ह करण्यासाठी कोणताही डेटा ऑन-स्क्रीन यादीत जोडलेला नाही."); return;
                }
                if (!employeeNameForPrint && !confirm("कर्मचाऱ्याचे नाव निवडलेले नाही. तरीही प्रिंट करायचे आहे का?")) {
                    document.getElementById("employeeName").focus(); return;
                }
                
                const printArea = document.getElementById("printOnlyArea");
                printArea.innerHTML = ""; 
                const headerDiv = document.createElement('div');
                headerDiv.className = 'print-header-block';
                headerDiv.innerHTML = `<h1>अनिक फायनान्सीयल सर्वीसेस प्रा.लि.</h1><h2>केज युनिट - एफ एक्स दैनंदिन अपडेट</h2>`;
                printArea.appendChild(headerDiv);
                const metaDiv = document.createElement('div');
                metaDiv.className = 'print-meta-info-block';
                let printEmployee = employeeNameForPrint || (allBorrowersDataForSheetAndPrint[0] ? allBorrowersDataForSheetAndPrint[0].employeeNameFromForm : "N/A");
                metaDiv.innerHTML = `<span><strong>कर्मचारी:</strong> ${printEmployee}</span><span><strong>दिनांक:</strong> ${getCurrentDateMarathi()}</span>`;
                printArea.appendChild(metaDiv);
                const entriesContainerDiv = document.createElement('div');
                entriesContainerDiv.className = 'print-entries-container';
                allBorrowersDataForSheetAndPrint.forEach((borrower, index) => { // Use combined array
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'print-borrower-item';
                    let amountReceivedText = "काही नाही";
                    if (borrower.amountReceived !== null && borrower.amountReceived !== undefined && borrower.amountReceived > 0) {
                        amountReceivedText = `₹${parseFloat(borrower.amountReceived).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
                    }
                    entryDiv.innerHTML = `<p><strong>क्र.:</strong> ${index + 1}</p><p><strong>कर्जदाराचे नांव:</strong> ${borrower.borrowerName}</p><p><strong>गावाचे नांव:</strong> ${borrower.villageName}</p><p><strong>मोबाईल नंबर:</strong> ${borrower.mobileNumber}</p><p><strong>खाते क्रमांक:</strong> ${borrower.accountNumber}</p><p><strong>वसूल रक्कम:</strong> ${amountReceivedText}</p><p><strong>झालेले बोलणे:</strong> ${borrower.discussionDetails.replace(/\n/g, '<br>')}</p><p><strong>उपाययोजना:</strong> ${borrower.recoveryPlan.replace(/\n/g, '<br>')}</p>`;
                    entriesContainerDiv.appendChild(entryDiv);
                });
                printArea.appendChild(entriesContainerDiv);
                setTimeout(function() { window.print(); }, 100);
            }

            // Save all listed data to Google Sheet
            async function saveAllListedDataToSheet() {
                const statusDiv = document.getElementById('sheetSaveStatus');
                
                if (allBorrowersDataForSheetAndPrint.length === 0) { // Use combined array
                    statusDiv.textContent = 'Google Sheet ला पाठवण्यासाठी कोणताही डेटा यादीत नाही.';
                    statusDiv.className = 'info'; return;
                }
                
                const currentEmployeeName = document.getElementById("employeeName").value;
                if (!currentEmployeeName) {
                    alert("डेटा शीटवर सेव्ह करण्यापूर्वी 'आपले नांव निवडा' अनिवार्य आहे. हे नाव सर्व यादीतील नोंदींसाठी लागू होईल.");
                    document.getElementById("employeeName").focus();
                    statusDiv.textContent = "कर्मचाऱ्याचे नाव निवडलेले नाही."; statusDiv.className = 'error';
                    return;
                }
                const dataToSend = allBorrowersDataForSheetAndPrint.map(entry => ({
                    ...entry,
                    employeeNameFromForm: currentEmployeeName // Ensure current employee name is used for all entries in batch
                }));


                statusDiv.textContent = `${dataToSend.length} नोंदी Google Sheet ला पाठवत आहे...`;
                statusDiv.className = 'info';

                console.log("Sending all listed data to Google Sheet URL:", SCRIPT_URL);
                console.log("Data to send (array):", dataToSend);

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'cors', cache: 'no-cache',
                        credentials: 'omit', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(dataToSend) 
                    });
                    
                    if (!response.ok) {
                       throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                    }
                    
                    const resultText = await response.text();
                    let result;
                    try {
                        result = JSON.parse(resultText); 
                    } catch (e) {
                        console.error("Response JSON parsing error:", resultText);
                        throw new Error("Apps Script प्रतिसाद समजू शकला नाही. Raw: " + resultText);
                    }

                    console.log("Apps Script response (batch):", result);

                    if (result.status === "success") {
                        statusDiv.textContent = result.message + ` (${new Date().toLocaleTimeString()}). हा डेटा प्रिंटसाठी अजूनही उपलब्ध आहे. नवीन डेटा जोडण्यासाठी फॉर्म रिकामा केला आहे.`;
                        statusDiv.className = 'success';
                        // allBorrowersDataForSheetAndPrint = []; // डेटा शीटवर गेल्यावर अॅरे रिकामा करू नका
                        // updateDisplayList();                 // यादी तशीच ठेवा
                        clearBorrowerFormFields(); // फक्त फॉर्म रिकामा करा नवीन एंट्रीसाठी
                    } else {
                        statusDiv.textContent = 'Sheet सेव्ह करताना त्रुटी: ' + result.message;
                        statusDiv.className = 'error';
                        console.error("Apps Script error (batch):", result.message);
                    }
                } catch (error) {
                    statusDiv.textContent = 'Sheet शी संपर्क त्रुटी: ' + error.message;
                    statusDiv.className = 'error';
                    console.error('Fetch error (batch) to Google Sheet:', error);
                }
            }

            updateDisplayList(); 

            const saveAllButton = document.getElementById('saveAllToListButton');
            if (saveAllButton) {
                saveAllButton.addEventListener('click', saveAllListedDataToSheet);
            }
            
            console.log("Initialization complete.");
        }; 
    </script>
</body>
</html>